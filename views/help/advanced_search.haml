-content_for :title do
  Helping #{@viewed_user.fullname}

-content_for :scripts do
  %script{src: "/js/application.js"}
  :javascript
    $(function() {
      Application.init(#{@viewed_user.id}, "POST", "/help-others", "#{@viewed_user.identifier}");
    });

-content_for :jumbotron do
  = haml :'partials/help/jumbotron', layout: false

- if !authorized?
  %p Want to help attribute specimens to #{@viewed_user.fullname}?

  %form{action: "/auth/orcid?lang=#{I18n.locale}", method: "POST" }
    %button{class: "btn btn-lg btn-outline-dark"}
      %i{class:"fab fa-orcid"}
      = I18n.t('home.orcid_login')
    %input{type:"hidden", name:"authenticity_token", value:"#{env['rack.session'][:csrf]}"}

  - if @viewed_user.is_public?
    %p{class:"mt-3"}
      View the
      = succeed "." do
        %a{href:"/#{@viewed_user.identifier}"} public profile

- else
  = haml :'partials/help/tabs', layout: false, locals: { active_tab: "discovered" }

  %div{class:"mt-3"}
    %h4= I18n.t('help.advanced_search_title')

    %form{method: :post, action: "/help-others/#{@viewed_user.identifier}/advanced-search", "accept-charset" => "UTF-8"}

      %div{class: "form-group"}
        %label{for: "typeahead", class:"font-weight-bold"}= I18n.t("help.dataset")
        %div{class:"col-12 col-md-8 pl-0"}
          %input{id: "typeahead-dataset", type: :text, name: "dataset", value: "#{params[:dataset]}", class:"typeahead"}
      %div{class: "form-group"}
        %label{for: "typeahead", class:"font-weight-bold"}= I18n.t(help.agent_string)
        %div{class:"col-12 col-md-8 pl-0"}
          %input{id: "typeahead-agent", type: :text, name: "agent", value: "#{params[:agent]}", class:"typeahead"}

      %input{type:"hidden", name:"authenticity_token", value:"#{env['rack.session'][:csrf]}"}
      %button{type:"submit", class:"btn btn-success"}= I18n.t('general.submit')

  - if params[:dataset] && params[:dataset].size > 0 && !@dataset_results.empty? && params[:agent] && params[:agent].size > 0 && !@agent_results.empty?
    %p{class:"mt-3"}
      %a{href: "#datasets"}
        = I18n.t('help.datasets')
      |
      %a{href:"#agents"}
        = I18n.t('help.agents')

  - if params[:dataset] && params[:dataset].size > 0 && !@dataset_results.empty?
    %a{name: "datasets"}
    %div{class: "alert alert-info tiny-margins", role: "alert"}
      Search results for
      = succeed "." do
        %span{class: "font-weight-bold"} #{h(params[:dataset])}
      Click dataset card below to execute a filter.

    - @dataset_results.in_groups_of(3).each do |group|
      %div{class: "card-deck"}
        - group.each do |d|
          - if d.nil?
            %div{class:"card border-0"}
          - else
            - dataset = Dataset.find(d[:id].to_i) rescue nil
            - if !dataset.nil?
              %div{class: "card card-profile m-3"}
                - if dataset.image_url
                  %div{class: "card-header d-flex"}
                    %div
                      %img{src:"#{organization_image(dataset, 'medium')}", alt:"#{dataset.title}", class:"mr-2 rounded"}
                    %div{class:"flex-grow-1"}
                      %h5
                        %a{href: "/help-others/#{@viewed_user.identifier}?datasetKey=#{dataset.datasetKey}"} #{dataset.title}
                      %p{class:"text-muted"}
                - else
                  %div{class: "card-header"}
                    %h5
                      %a{href: "/help-others/#{@viewed_user.identifier}?datasetKey=#{dataset.datasetKey}"} #{dataset.title}
                    %p{class:"text-muted"}
                %div{class: "card-body"}

                %div{class: "card-footer"}
                  %div{class: "col small text-left text-muted"}
                  %div{class: "col small text-right text-muted"}
                    %a{href: "#{dataset.license}"}
                      %img{src:"#{dataset.license_icon("small")}"}

  - elsif params[:dataset] && params[:dataset].size > 0 && @dataset_results.empty?
    %div{class: "alert alert-warning tiny-margins", role: "alert"}
      Dataset not found using the search
      %span{class: "font-weight-bold"} #{h(params[:dataset])}


  - if @agent_results && !@agent_results.empty?
    %a{name: "agents"}
    %div{class: "alert alert-info tiny-margins", role: "alert"}
      Search results for
      = succeed "." do
        %span{class: "font-weight-bold"} #{h(params[:agent])}
      Click agent string below to execute a search.

    %div{class: "row"}
      - @agent_results.in_groups_of(25, false).each do |group|
        %div{class: "col-12 col-md-3 mb-3"}
          %ul{class: "list-unstyled m-2"}
            - group.each do |o|
              %li
                %a{href: "/help-others/#{@viewed_user.identifier}?agent_id=#{o[:id]}"} #{o[:fullname_reverse]}

  - elsif params[:agent] && params[:agent].size > 0 && @agent_results.empty?
    %div{class: "alert alert-warning tiny-margins", role: "alert"}
      Agent string not found using the search
      %span{class: "font-weight-bold"} #{h(params[:agent])}
