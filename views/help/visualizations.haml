-content_for :title do
  Help Fix Attributions for #{@viewed_user.fullname}

-content_for :scripts do
  %script{src: "//www.gstatic.com/charts/loader.js"}
  :javascript
    $(function() {
          var countriesRecorded = #{@stats[:countries][:recorded].to_a.unshift(["Country", "Collected"])},
              countriesIdentified = #{@stats[:countries][:identified].to_a.unshift(["Country", "Identified"])},
              dateData = #{@stats[:activity_dates].to_a.unshift(["Year", "Identified", "Collected"])};

          function drawVisualizations() {
            var chartData = google.visualization.arrayToDataTable(dateData),
                collectedMap = new google.visualization.GeoChart($('#map-collected')[0]),
                identifiedMap = new google.visualization.GeoChart($('#map-identified')[0]),
                chart = new google.visualization.ColumnChart($('#chart')[0]),
                chartOptions = {
                  title: '',
                  hAxis: {
                    title: 'Year',
                    format: '0000',
                    titleTextStyle: {
                      italic: false,
                      fontSize: 18,
                      bold: true
                    }
                  },
                  vAxis: {
                    title: '# specimens',
                    titleTextStyle: {
                      italic: false,
                      fontSize: 18,
                      bold: true
                    }
                  },
                  colors: ['#bce7fa', '#0071a4'],
                  chartArea: {
                    right: 130,
                    left: 60,
                  }
                },
                mapOptions = {
                  colorAxis: { colors: ['#bce7fa', '#0071a4'] },
                  legend: 'none'
                };

            google.visualization.events.addListener(chart, 'onmouseover', function() { $('#chart').css('cursor','pointer'); });
            google.visualization.events.addListener(chart, 'onmouseout', function() { $('#chart').css('cursor','default'); });
            google.visualization.events.addListener(chart, 'select', function() {
              var sel = chart.getSelection()[0];
              if (typeof sel.row !== "undefined" && sel.row !== null) {
                var yr = chartData.getValue(sel.row, 0), label = chartData.getColumnLabel(sel.column);
                window.location = "/help-others/#{@viewed_user.identifier}/specimens/" + label.toLowerCase() + "/" + yr + "-" + (parseInt(yr, 10)+5);
              }
            });
            $.each([collectedMap, identifiedMap], function() {
              var label = (this === collectedMap) ? "collected" : "identified";
              google.visualization.events.addListener(this, 'regionClick', function(e) {
                window.location = "/help-others/#{@viewed_user.identifier}/specimens/" + label + "/" + e.region;
              });
            });

            if (dateData.length > 1) {
              chart.draw(chartData, chartOptions);
            }
            collectedMap.draw(google.visualization.arrayToDataTable(countriesRecorded), mapOptions);
            identifiedMap.draw(google.visualization.arrayToDataTable(countriesIdentified), mapOptions);
          }

          google.charts.load('current', {
            packages: ['corechart', 'bar', 'geochart'],
            mapsApiKey: "#{Settings.google.api_key}"
          });
          google.charts.setOnLoadCallback(drawVisualizations);
    });

-content_for :jumbotron do
  = haml :'partials/help/jumbotron', layout: false

= haml :'partials/help/tabs', layout: false, locals: { active_tab: "specimens" }
= haml :'partials/help/subtabs_fix', layout: false, locals: { active_subtab: "visualizations" }

%div{id: "helper-info", class: "alert alert-info tiny-margins", role: "alert"}
  Click regions on the map or bars in the chart to execute a filter.

- if @stats[:specimens][:identified] > 0 || @stats[:specimens][:recorded] > 0
  %div{class:"row d-flex mt-3"}
    %div{class:"col-10 col-md-6"}
      %h4 Identified From
      #map-identified{style:"width: 100%; height: 350px"}
    %div{class:"col-10 col-md-6"}
      %h4 Collected From
      #map-collected{style:"width: 100%; height: 350px"}
- else
  #map-identified{style:"width: 0%; height: 0%; display: none;"}
  #map-collected{style:"width: 0%; height: 0%; display: none;"}


- if @stats[:activity_dates].length > 0
  %h4 Dates Identified and Collected
  %div{id: "chart"}
- else
  %div{id: "chart", style:"width: 0%; height: 0%; display:none;"}

- if @viewed_user.wikidata
  %h4 Other Filters

  #TODO: query these straight away

  %p
    Collections made before birth
  %p
    Collections made after death
  %p
    Identifications made before birth
  %p
    Identififcations made after death
