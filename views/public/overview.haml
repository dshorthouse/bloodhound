= haml :'partials/user_twitter_img', layout: false

- content_for(:title, "#{@viewed_user.fullname}")

- content_for :stylesheets do
  - if @viewed_user.is_public? && !@total[:country_counts].empty?
    %link{rel:"stylesheet", href:"/css/jquery-jvectormap-2.0.3.css"}

- content_for :scripts do
  - if @viewed_user.is_public?
    %script{src: "/js/progress-bar.js"}
    :javascript
      $(function() {
        ProgressBar.init("#{@viewed_user.identifier}");
      });

  %script{id:"dsq-count-scr", src:"//#{Settings.disqus_shortname}.disqus.com/count.js", defer: ""}

  - if @viewed_user.is_public? && !@total[:country_counts].empty?
    %script{src: "/js/jquery-jvectormap-2.0.3.min.js"}
    %script{src: "/js/jquery-jvectormap-world-mill.js"}
    :javascript
      var countryData=#{@total[:country_counts].to_json};
  
      $(function() {
        var map = $('#world-map');
        DISQUSWIDGETS.getCount({reset: true});
        if (Object.keys(countryData).length > 0) {
          map.vectorMap({
            map: 'world_mill',
            backgroundColor: '#fff',
            regionStyle: {
              initial: {
                fill: "#e9ecef"
              },
              hover: {
                cursor: "normal",
                stroke: "#D3633C",
                "stroke-width": 1
              }
            },
            focusOn: Object.keys(countryData),
            series: {
              regions: [{
                values: Object.keys(countryData).reduce(function (result,item) {
                  result[item] = countryData[item].count;
                  return result; 
                }, {}),
                scale: ['#C8EEFF', '#0071A4'],
                normalizeFunction: 'polynomial'
              }]
            },
            onRegionTipShow: function(e, el, code) {
              count = 0
              if (countryData.hasOwnProperty(code)) {
                count = countryData[code].count;
              }
              el.html(el.html()+' ('+count+')');
            }
          });
        }
      });

%div{class:"row"}
  = haml :'partials/user_jumbotron', layout: false
  %div{class:"col-12 col-lg-8 mt-2"}
    - if @viewed_user.is_public?
      = haml :'partials/user_tabs', layout: false, locals: { active_page: "overview" }

      %div{class:"d-flex flex-row mt-3 alert alert-info justify-content-between"}
        - if @total[:number_identified] == 0 && @total[:number_recorded] == 0 && @total[:number_helped] == 0
          Claims or attributions have not yet been recorded.
        - else
          %div
            %ul{class:"list-unstyled"}
              - if @total[:number_identified] > 0
                %li Identified #{number_with_delimiter(@total[:number_identified])} #{'specimen'.pluralize(@total[:number_identified])}
              - if @total[:number_recorded] > 0
                %li Collected #{number_with_delimiter(@total[:number_recorded])} #{'specimen'.pluralize(@total[:number_recorded])} from at least #{number_with_delimiter(@total[:country_counts].count)} #{'country'.pluralize(@total[:country_counts].count)}
              - if @total[:number_helped] > 0
                %li Attributed #{number_with_delimiter(@total[:number_claims_given])} #{'specimen'.pluralize(@total[:number_claims_given])} to #{number_with_delimiter(@total[:number_helped])} #{'person'.pluralize(@total[:number_helped])}
              - if @total[:number_specimens_cited] > 0
                %li #{number_with_delimiter(@total[:number_specimens_cited])} #{'specimen'.pluralize(@total[:number_specimens_cited])} used in #{number_with_delimiter(@total[:number_articles])} published #{'work'.pluralize(@total[:number_articles])}
          - if @total[:number_recorded] > 0 || @total[:number_identified] > 0
            %div{class:"col-4 col-md-2"}
              Progress
              %div{class:"progress", style:"border:1px solid rgba(0,0,0,.125);inline"}
                %div{id:"progress-bar_#{@viewed_user.identifier}", class:"progress-bar bg-info", role:"progressbar", style:"width: 0%;inline", "aria-valuenow":"0", "aria-valuemin":"0", "aria-valuemax":"100"}

      - if !@total[:country_counts].empty?
        %div{class:"row d-flex justify-content-center"}
          %div{class:"col col-sm-12 col-md-10 col-xl-10"}
            #world-map{style:"width: 100%; height: 350px"}

    - else
      %div{class: "alert alert-warning"}
        - specimen_count = @viewed_user.all_occurrences_count
        - if specimen_count > 0
          %i{class:"fas fa-lock"}
          Although #{number_with_delimiter(specimen_count)} #{'specimen'.pluralize(specimen_count)} were claimed or attributed, this profile
        - else
          %i{class:"fas fa-lock"}
          Profile
        is not publicly available.